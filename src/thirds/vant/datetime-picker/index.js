"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var component_1 = require('./../common/component.js');
var utils_1 = require('./../common/utils.js');
var currentYear = new Date().getFullYear();
function isValidDate(date) {
    return utils_1.isDef(date) && !isNaN(new Date(date).getTime());
}
function range(num, min, max) {
    return Math.min(Math.max(num, min), max);
}
function padZero(val) {
    return ("00" + val).slice(-2);
}
function times(n, iteratee) {
    var index = -1;
    var result = Array(n);
    while (++index < n) {
        result[index] = iteratee(index);
    }
    return result;
}
function getTrueValue(formattedValue) {
    if (!formattedValue) return;
    while (isNaN(parseInt(formattedValue, 10))) {
        formattedValue = formattedValue.slice(1);
    }
    return parseInt(formattedValue, 10);
}
function getMonthEndDay(year, month) {
    return 32 - new Date(year, month - 1, 32).getDate();
}
component_1.VantComponent({
    props: {
        value: null,
        title: String,
        loading: Boolean,
        itemHeight: {
            type: Number,
            value: 44
        },
        visibleItemCount: {
            type: Number,
            value: 5
        },
        confirmButtonText: {
            type: String,
            value: '确认'
        },
        cancelButtonText: {
            type: String,
            value: '取消'
        },
        type: {
            type: String,
            value: 'datetime'
        },
        showToolbar: {
            type: Boolean,
            value: true
        },
        minDate: {
            type: Number,
            value: new Date(currentYear - 10, 0, 1).getTime()
        },
        maxDate: {
            type: Number,
            value: new Date(currentYear + 10, 11, 31).getTime()
        },
        minHour: {
            type: Number,
            value: 0
        },
        maxHour: {
            type: Number,
            value: 23
        },
        minMinute: {
            type: Number,
            value: 0
        },
        maxMinute: {
            type: Number,
            value: 59
        }
    },
    data: {
        innerValue: Date.now(),
        columns: []
    },
    watch: {
        value: function value(val) {
            var _this = this;
            var data = this.data;
            val = this.correctValue(val);
            var isEqual = val === data.innerValue;
            if (!isEqual) {
                this.updateColumnValue(val).then(function () {
                    _this.$emit('input', val);
                });
            }
        },
        type: 'updateColumns',
        minHour: 'updateColumns',
        maxHour: 'updateColumns',
        minMinute: 'updateColumns',
        maxMinute: 'updateColumns'
    },
    methods: {
        getPicker: function getPicker() {
            if (this.picker == null) {
                var picker_1 = this.picker = this.selectComponent('.van-datetime-picker');
                var setColumnValues_1 = picker_1.setColumnValues;
                picker_1.setColumnValues = function () {
                    var args = [];
                    for (var _i = 0; _i < arguments.length; _i++) {
                        args[_i] = arguments[_i];
                    }
                    return setColumnValues_1.apply(picker_1, args.concat([false]));
                };
            }
            return this.picker;
        },
        updateColumns: function updateColumns() {
            var results = this.getRanges().map(function (_a, index) {
                var type = _a.type,
                    range = _a.range;
                var values = times(range[1] - range[0] + 1, function (index) {
                    var value = range[0] + index;
                    value = type === 'year' ? "" + value : padZero(value);
                    return value;
                });
                return { values: values };
            });
            return this.set({ columns: results });
        },
        getRanges: function getRanges() {
            var data = this.data;
            if (data.type === 'time') {
                return [{
                    type: 'hour',
                    range: [data.minHour, data.maxHour]
                }, {
                    type: 'minute',
                    range: [data.minMinute, data.maxMinute]
                }];
            }
            var _a = this.getBoundary('max', data.innerValue),
                maxYear = _a.maxYear,
                maxDate = _a.maxDate,
                maxMonth = _a.maxMonth,
                maxHour = _a.maxHour,
                maxMinute = _a.maxMinute;
            var _b = this.getBoundary('min', data.innerValue),
                minYear = _b.minYear,
                minDate = _b.minDate,
                minMonth = _b.minMonth,
                minHour = _b.minHour,
                minMinute = _b.minMinute;
            var result = [{
                type: 'year',
                range: [minYear, maxYear]
            }, {
                type: 'month',
                range: [minMonth, maxMonth]
            }, {
                type: 'day',
                range: [minDate, maxDate]
            }, {
                type: 'hour',
                range: [minHour, maxHour]
            }, {
                type: 'minute',
                range: [minMinute, maxMinute]
            }];
            if (data.type === 'date') result.splice(3, 2);
            if (data.type === 'year-month') result.splice(2, 3);
            return result;
        },
        correctValue: function correctValue(value) {
            var data = this.data;
            // validate value
            var isDateType = data.type !== 'time';
            if (isDateType && !isValidDate(value)) {
                value = data.minDate;
            } else if (!isDateType && !value) {
                var minHour = data.minHour;
                value = padZero(minHour) + ":00";
            }
            // time type
            if (!isDateType) {
                var _a = value.split(':'),
                    hour = _a[0],
                    minute = _a[1];
                hour = padZero(range(hour, data.minHour, data.maxHour));
                minute = padZero(range(minute, data.minMinute, data.maxMinute));
                return hour + ":" + minute;
            }
            // date type
            value = Math.max(value, data.minDate);
            value = Math.min(value, data.maxDate);
            return value;
        },
        getBoundary: function getBoundary(type, innerValue) {
            var _a;
            var value = new Date(innerValue);
            var boundary = new Date(this.data[type + "Date"]);
            var year = boundary.getFullYear();
            var month = 1;
            var date = 1;
            var hour = 0;
            var minute = 0;
            if (type === 'max') {
                month = 12;
                date = getMonthEndDay(value.getFullYear(), value.getMonth() + 1);
                hour = 23;
                minute = 59;
            }
            if (value.getFullYear() === year) {
                month = boundary.getMonth() + 1;
                if (value.getMonth() + 1 === month) {
                    date = boundary.getDate();
                    if (value.getDate() === date) {
                        hour = boundary.getHours();
                        if (value.getHours() === hour) {
                            minute = boundary.getMinutes();
                        }
                    }
                }
            }
            return _a = {}, _a[type + "Year"] = year, _a[type + "Month"] = month, _a[type + "Date"] = date, _a[type + "Hour"] = hour, _a[type + "Minute"] = minute, _a;
        },
        onCancel: function onCancel() {
            this.$emit('cancel');
        },
        onConfirm: function onConfirm() {
            this.$emit('confirm', this.data.innerValue);
        },
        onChange: function onChange() {
            var _this = this;
            var data = this.data;
            var value;
            var picker = this.getPicker();
            if (data.type === 'time') {
                var indexes = picker.getIndexes();
                value = indexes[0] + data.minHour + ":" + (indexes[1] + data.minMinute);
            } else {
                var values = picker.getValues();
                var year = getTrueValue(values[0]);
                var month = getTrueValue(values[1]);
                var maxDate = getMonthEndDay(year, month);
                var date = getTrueValue(values[2]);
                if (data.type === 'year-month') {
                    date = 1;
                }
                date = date > maxDate ? maxDate : date;
                var hour = 0;
                var minute = 0;
                if (data.type === 'datetime') {
                    hour = getTrueValue(values[3]);
                    minute = getTrueValue(values[4]);
                }
                value = new Date(year, month - 1, date, hour, minute);
            }
            value = this.correctValue(value);
            this.updateColumnValue(value).then(function () {
                _this.$emit('input', value);
                _this.$emit('change', picker);
            });
        },
        updateColumnValue: function updateColumnValue(value) {
            var _this = this;
            var values = [];
            var data = this.data;
            var picker = this.getPicker();
            if (data.type === 'time') {
                var pair = value.split(':');
                values = [pair[0], pair[1]];
            } else {
                var date = new Date(value);
                values = ["" + date.getFullYear(), padZero(date.getMonth() + 1)];
                if (data.type === 'date') {
                    values.push(padZero(date.getDate()));
                }
                if (data.type === 'datetime') {
                    values.push(padZero(date.getDate()), padZero(date.getHours()), padZero(date.getMinutes()));
                }
            }
            return this.set({ innerValue: value }).then(function () {
                return _this.updateColumns();
            }).then(function () {
                return picker.setValues(values);
            });
        }
    },
    created: function created() {
        var _this = this;
        var innerValue = this.correctValue(this.data.value);
        this.updateColumnValue(innerValue).then(function () {
            _this.$emit('input', innerValue);
        });
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiY29tcG9uZW50XzEiLCJyZXF1aXJlIiwidXRpbHNfMSIsImN1cnJlbnRZZWFyIiwiRGF0ZSIsImdldEZ1bGxZZWFyIiwiaXNWYWxpZERhdGUiLCJkYXRlIiwiaXNEZWYiLCJpc05hTiIsImdldFRpbWUiLCJyYW5nZSIsIm51bSIsIm1pbiIsIm1heCIsIk1hdGgiLCJwYWRaZXJvIiwidmFsIiwic2xpY2UiLCJ0aW1lcyIsIm4iLCJpdGVyYXRlZSIsImluZGV4IiwicmVzdWx0IiwiQXJyYXkiLCJnZXRUcnVlVmFsdWUiLCJmb3JtYXR0ZWRWYWx1ZSIsInBhcnNlSW50IiwiZ2V0TW9udGhFbmREYXkiLCJ5ZWFyIiwibW9udGgiLCJnZXREYXRlIiwiVmFudENvbXBvbmVudCIsInByb3BzIiwidGl0bGUiLCJTdHJpbmciLCJsb2FkaW5nIiwiQm9vbGVhbiIsIml0ZW1IZWlnaHQiLCJ0eXBlIiwiTnVtYmVyIiwidmlzaWJsZUl0ZW1Db3VudCIsImNvbmZpcm1CdXR0b25UZXh0IiwiY2FuY2VsQnV0dG9uVGV4dCIsInNob3dUb29sYmFyIiwibWluRGF0ZSIsIm1heERhdGUiLCJtaW5Ib3VyIiwibWF4SG91ciIsIm1pbk1pbnV0ZSIsIm1heE1pbnV0ZSIsImRhdGEiLCJpbm5lclZhbHVlIiwibm93IiwiY29sdW1ucyIsIndhdGNoIiwiX3RoaXMiLCJjb3JyZWN0VmFsdWUiLCJpc0VxdWFsIiwidXBkYXRlQ29sdW1uVmFsdWUiLCJ0aGVuIiwiJGVtaXQiLCJtZXRob2RzIiwiZ2V0UGlja2VyIiwicGlja2VyIiwicGlja2VyXzEiLCJzZWxlY3RDb21wb25lbnQiLCJzZXRDb2x1bW5WYWx1ZXNfMSIsInNldENvbHVtblZhbHVlcyIsImFyZ3MiLCJfaSIsImFyZ3VtZW50cyIsImxlbmd0aCIsImFwcGx5IiwiY29uY2F0IiwidXBkYXRlQ29sdW1ucyIsInJlc3VsdHMiLCJnZXRSYW5nZXMiLCJtYXAiLCJfYSIsInZhbHVlcyIsInNldCIsImdldEJvdW5kYXJ5IiwibWF4WWVhciIsIm1heE1vbnRoIiwiX2IiLCJtaW5ZZWFyIiwibWluTW9udGgiLCJzcGxpY2UiLCJpc0RhdGVUeXBlIiwic3BsaXQiLCJob3VyIiwibWludXRlIiwiYm91bmRhcnkiLCJnZXRNb250aCIsImdldEhvdXJzIiwiZ2V0TWludXRlcyIsIm9uQ2FuY2VsIiwib25Db25maXJtIiwib25DaGFuZ2UiLCJpbmRleGVzIiwiZ2V0SW5kZXhlcyIsImdldFZhbHVlcyIsInBhaXIiLCJwdXNoIiwic2V0VmFsdWVzIiwiY3JlYXRlZCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0FBLE9BQU9DLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDLEVBQUVDLE9BQU8sSUFBVCxFQUE3QztBQUNBLElBQUlDLGNBQWNDLFFBQVEscUJBQVIsQ0FBbEI7QUFDQSxJQUFJQyxVQUFVRCxRQUFRLGlCQUFSLENBQWQ7QUFDQSxJQUFJRSxjQUFjLElBQUlDLElBQUosR0FBV0MsV0FBWCxFQUFsQjtBQUNBLFNBQVNDLFdBQVQsQ0FBcUJDLElBQXJCLEVBQTJCO0FBQ3ZCLFdBQU9MLFFBQVFNLEtBQVIsQ0FBY0QsSUFBZCxLQUF1QixDQUFDRSxNQUFNLElBQUlMLElBQUosQ0FBU0csSUFBVCxFQUFlRyxPQUFmLEVBQU4sQ0FBL0I7QUFDSDtBQUNELFNBQVNDLEtBQVQsQ0FBZUMsR0FBZixFQUFvQkMsR0FBcEIsRUFBeUJDLEdBQXpCLEVBQThCO0FBQzFCLFdBQU9DLEtBQUtGLEdBQUwsQ0FBU0UsS0FBS0QsR0FBTCxDQUFTRixHQUFULEVBQWNDLEdBQWQsQ0FBVCxFQUE2QkMsR0FBN0IsQ0FBUDtBQUNIO0FBQ0QsU0FBU0UsT0FBVCxDQUFpQkMsR0FBakIsRUFBc0I7QUFDbEIsV0FBTyxDQUFDLE9BQU9BLEdBQVIsRUFBYUMsS0FBYixDQUFtQixDQUFDLENBQXBCLENBQVA7QUFDSDtBQUNELFNBQVNDLEtBQVQsQ0FBZUMsQ0FBZixFQUFrQkMsUUFBbEIsRUFBNEI7QUFDeEIsUUFBSUMsUUFBUSxDQUFDLENBQWI7QUFDQSxRQUFJQyxTQUFTQyxNQUFNSixDQUFOLENBQWI7QUFDQSxXQUFPLEVBQUVFLEtBQUYsR0FBVUYsQ0FBakIsRUFBb0I7QUFDaEJHLGVBQU9ELEtBQVAsSUFBZ0JELFNBQVNDLEtBQVQsQ0FBaEI7QUFDSDtBQUNELFdBQU9DLE1BQVA7QUFDSDtBQUNELFNBQVNFLFlBQVQsQ0FBc0JDLGNBQXRCLEVBQXNDO0FBQ2xDLFFBQUksQ0FBQ0EsY0FBTCxFQUNJO0FBQ0osV0FBT2pCLE1BQU1rQixTQUFTRCxjQUFULEVBQXlCLEVBQXpCLENBQU4sQ0FBUCxFQUE0QztBQUN4Q0EseUJBQWlCQSxlQUFlUixLQUFmLENBQXFCLENBQXJCLENBQWpCO0FBQ0g7QUFDRCxXQUFPUyxTQUFTRCxjQUFULEVBQXlCLEVBQXpCLENBQVA7QUFDSDtBQUNELFNBQVNFLGNBQVQsQ0FBd0JDLElBQXhCLEVBQThCQyxLQUE5QixFQUFxQztBQUNqQyxXQUFPLEtBQUssSUFBSTFCLElBQUosQ0FBU3lCLElBQVQsRUFBZUMsUUFBUSxDQUF2QixFQUEwQixFQUExQixFQUE4QkMsT0FBOUIsRUFBWjtBQUNIO0FBQ0QvQixZQUFZZ0MsYUFBWixDQUEwQjtBQUN0QkMsV0FBTztBQUNIbEMsZUFBTyxJQURKO0FBRUhtQyxlQUFPQyxNQUZKO0FBR0hDLGlCQUFTQyxPQUhOO0FBSUhDLG9CQUFZO0FBQ1JDLGtCQUFNQyxNQURFO0FBRVJ6QyxtQkFBTztBQUZDLFNBSlQ7QUFRSDBDLDBCQUFrQjtBQUNkRixrQkFBTUMsTUFEUTtBQUVkekMsbUJBQU87QUFGTyxTQVJmO0FBWUgyQywyQkFBbUI7QUFDZkgsa0JBQU1KLE1BRFM7QUFFZnBDLG1CQUFPO0FBRlEsU0FaaEI7QUFnQkg0QywwQkFBa0I7QUFDZEosa0JBQU1KLE1BRFE7QUFFZHBDLG1CQUFPO0FBRk8sU0FoQmY7QUFvQkh3QyxjQUFNO0FBQ0ZBLGtCQUFNSixNQURKO0FBRUZwQyxtQkFBTztBQUZMLFNBcEJIO0FBd0JINkMscUJBQWE7QUFDVEwsa0JBQU1GLE9BREc7QUFFVHRDLG1CQUFPO0FBRkUsU0F4QlY7QUE0Qkg4QyxpQkFBUztBQUNMTixrQkFBTUMsTUFERDtBQUVMekMsbUJBQU8sSUFBSUssSUFBSixDQUFTRCxjQUFjLEVBQXZCLEVBQTJCLENBQTNCLEVBQThCLENBQTlCLEVBQWlDTyxPQUFqQztBQUZGLFNBNUJOO0FBZ0NIb0MsaUJBQVM7QUFDTFAsa0JBQU1DLE1BREQ7QUFFTHpDLG1CQUFPLElBQUlLLElBQUosQ0FBU0QsY0FBYyxFQUF2QixFQUEyQixFQUEzQixFQUErQixFQUEvQixFQUFtQ08sT0FBbkM7QUFGRixTQWhDTjtBQW9DSHFDLGlCQUFTO0FBQ0xSLGtCQUFNQyxNQUREO0FBRUx6QyxtQkFBTztBQUZGLFNBcENOO0FBd0NIaUQsaUJBQVM7QUFDTFQsa0JBQU1DLE1BREQ7QUFFTHpDLG1CQUFPO0FBRkYsU0F4Q047QUE0Q0hrRCxtQkFBVztBQUNQVixrQkFBTUMsTUFEQztBQUVQekMsbUJBQU87QUFGQSxTQTVDUjtBQWdESG1ELG1CQUFXO0FBQ1BYLGtCQUFNQyxNQURDO0FBRVB6QyxtQkFBTztBQUZBO0FBaERSLEtBRGU7QUFzRHRCb0QsVUFBTTtBQUNGQyxvQkFBWWhELEtBQUtpRCxHQUFMLEVBRFY7QUFFRkMsaUJBQVM7QUFGUCxLQXREZ0I7QUEwRHRCQyxXQUFPO0FBQ0h4RCxlQUFPLGVBQVVrQixHQUFWLEVBQWU7QUFDbEIsZ0JBQUl1QyxRQUFRLElBQVo7QUFDQSxnQkFBSUwsT0FBTyxLQUFLQSxJQUFoQjtBQUNBbEMsa0JBQU0sS0FBS3dDLFlBQUwsQ0FBa0J4QyxHQUFsQixDQUFOO0FBQ0EsZ0JBQUl5QyxVQUFVekMsUUFBUWtDLEtBQUtDLFVBQTNCO0FBQ0EsZ0JBQUksQ0FBQ00sT0FBTCxFQUFjO0FBQ1YscUJBQUtDLGlCQUFMLENBQXVCMUMsR0FBdkIsRUFBNEIyQyxJQUE1QixDQUFpQyxZQUFZO0FBQ3pDSiwwQkFBTUssS0FBTixDQUFZLE9BQVosRUFBcUI1QyxHQUFyQjtBQUNILGlCQUZEO0FBR0g7QUFDSixTQVhFO0FBWUhzQixjQUFNLGVBWkg7QUFhSFEsaUJBQVMsZUFiTjtBQWNIQyxpQkFBUyxlQWROO0FBZUhDLG1CQUFXLGVBZlI7QUFnQkhDLG1CQUFXO0FBaEJSLEtBMURlO0FBNEV0QlksYUFBUztBQUNMQyxtQkFBVyxxQkFBWTtBQUNuQixnQkFBSSxLQUFLQyxNQUFMLElBQWUsSUFBbkIsRUFBeUI7QUFDckIsb0JBQUlDLFdBQVcsS0FBS0QsTUFBTCxHQUFjLEtBQUtFLGVBQUwsQ0FBcUIsc0JBQXJCLENBQTdCO0FBQ0Esb0JBQUlDLG9CQUFvQkYsU0FBU0csZUFBakM7QUFDQUgseUJBQVNHLGVBQVQsR0FBMkIsWUFBWTtBQUNuQyx3QkFBSUMsT0FBTyxFQUFYO0FBQ0EseUJBQUssSUFBSUMsS0FBSyxDQUFkLEVBQWlCQSxLQUFLQyxVQUFVQyxNQUFoQyxFQUF3Q0YsSUFBeEMsRUFBOEM7QUFDMUNELDZCQUFLQyxFQUFMLElBQVdDLFVBQVVELEVBQVYsQ0FBWDtBQUNIO0FBQ0QsMkJBQU9ILGtCQUFrQk0sS0FBbEIsQ0FBd0JSLFFBQXhCLEVBQWtDSSxLQUFLSyxNQUFMLENBQVksQ0FBQyxLQUFELENBQVosQ0FBbEMsQ0FBUDtBQUNILGlCQU5EO0FBT0g7QUFDRCxtQkFBTyxLQUFLVixNQUFaO0FBQ0gsU0FkSTtBQWVMVyx1QkFBZSx5QkFBWTtBQUN2QixnQkFBSUMsVUFBVSxLQUFLQyxTQUFMLEdBQWlCQyxHQUFqQixDQUFxQixVQUFVQyxFQUFWLEVBQWN6RCxLQUFkLEVBQXFCO0FBQ3BELG9CQUFJaUIsT0FBT3dDLEdBQUd4QyxJQUFkO0FBQUEsb0JBQW9CNUIsUUFBUW9FLEdBQUdwRSxLQUEvQjtBQUNBLG9CQUFJcUUsU0FBUzdELE1BQU1SLE1BQU0sQ0FBTixJQUFXQSxNQUFNLENBQU4sQ0FBWCxHQUFzQixDQUE1QixFQUErQixVQUFVVyxLQUFWLEVBQWlCO0FBQ3pELHdCQUFJdkIsUUFBUVksTUFBTSxDQUFOLElBQVdXLEtBQXZCO0FBQ0F2Qiw0QkFBUXdDLFNBQVMsTUFBVCxHQUFrQixLQUFLeEMsS0FBdkIsR0FBK0JpQixRQUFRakIsS0FBUixDQUF2QztBQUNBLDJCQUFPQSxLQUFQO0FBQ0gsaUJBSlksQ0FBYjtBQUtBLHVCQUFPLEVBQUVpRixRQUFRQSxNQUFWLEVBQVA7QUFDSCxhQVJhLENBQWQ7QUFTQSxtQkFBTyxLQUFLQyxHQUFMLENBQVMsRUFBRTNCLFNBQVNzQixPQUFYLEVBQVQsQ0FBUDtBQUNILFNBMUJJO0FBMkJMQyxtQkFBVyxxQkFBWTtBQUNuQixnQkFBSTFCLE9BQU8sS0FBS0EsSUFBaEI7QUFDQSxnQkFBSUEsS0FBS1osSUFBTCxLQUFjLE1BQWxCLEVBQTBCO0FBQ3RCLHVCQUFPLENBQ0g7QUFDSUEsMEJBQU0sTUFEVjtBQUVJNUIsMkJBQU8sQ0FBQ3dDLEtBQUtKLE9BQU4sRUFBZUksS0FBS0gsT0FBcEI7QUFGWCxpQkFERyxFQUtIO0FBQ0lULDBCQUFNLFFBRFY7QUFFSTVCLDJCQUFPLENBQUN3QyxLQUFLRixTQUFOLEVBQWlCRSxLQUFLRCxTQUF0QjtBQUZYLGlCQUxHLENBQVA7QUFVSDtBQUNELGdCQUFJNkIsS0FBSyxLQUFLRyxXQUFMLENBQWlCLEtBQWpCLEVBQXdCL0IsS0FBS0MsVUFBN0IsQ0FBVDtBQUFBLGdCQUFtRCtCLFVBQVVKLEdBQUdJLE9BQWhFO0FBQUEsZ0JBQXlFckMsVUFBVWlDLEdBQUdqQyxPQUF0RjtBQUFBLGdCQUErRnNDLFdBQVdMLEdBQUdLLFFBQTdHO0FBQUEsZ0JBQXVIcEMsVUFBVStCLEdBQUcvQixPQUFwSTtBQUFBLGdCQUE2SUUsWUFBWTZCLEdBQUc3QixTQUE1SjtBQUNBLGdCQUFJbUMsS0FBSyxLQUFLSCxXQUFMLENBQWlCLEtBQWpCLEVBQXdCL0IsS0FBS0MsVUFBN0IsQ0FBVDtBQUFBLGdCQUFtRGtDLFVBQVVELEdBQUdDLE9BQWhFO0FBQUEsZ0JBQXlFekMsVUFBVXdDLEdBQUd4QyxPQUF0RjtBQUFBLGdCQUErRjBDLFdBQVdGLEdBQUdFLFFBQTdHO0FBQUEsZ0JBQXVIeEMsVUFBVXNDLEdBQUd0QyxPQUFwSTtBQUFBLGdCQUE2SUUsWUFBWW9DLEdBQUdwQyxTQUE1SjtBQUNBLGdCQUFJMUIsU0FBUyxDQUNUO0FBQ0lnQixzQkFBTSxNQURWO0FBRUk1Qix1QkFBTyxDQUFDMkUsT0FBRCxFQUFVSCxPQUFWO0FBRlgsYUFEUyxFQUtUO0FBQ0k1QyxzQkFBTSxPQURWO0FBRUk1Qix1QkFBTyxDQUFDNEUsUUFBRCxFQUFXSCxRQUFYO0FBRlgsYUFMUyxFQVNUO0FBQ0k3QyxzQkFBTSxLQURWO0FBRUk1Qix1QkFBTyxDQUFDa0MsT0FBRCxFQUFVQyxPQUFWO0FBRlgsYUFUUyxFQWFUO0FBQ0lQLHNCQUFNLE1BRFY7QUFFSTVCLHVCQUFPLENBQUNvQyxPQUFELEVBQVVDLE9BQVY7QUFGWCxhQWJTLEVBaUJUO0FBQ0lULHNCQUFNLFFBRFY7QUFFSTVCLHVCQUFPLENBQUNzQyxTQUFELEVBQVlDLFNBQVo7QUFGWCxhQWpCUyxDQUFiO0FBc0JBLGdCQUFJQyxLQUFLWixJQUFMLEtBQWMsTUFBbEIsRUFDSWhCLE9BQU9pRSxNQUFQLENBQWMsQ0FBZCxFQUFpQixDQUFqQjtBQUNKLGdCQUFJckMsS0FBS1osSUFBTCxLQUFjLFlBQWxCLEVBQ0loQixPQUFPaUUsTUFBUCxDQUFjLENBQWQsRUFBaUIsQ0FBakI7QUFDSixtQkFBT2pFLE1BQVA7QUFDSCxTQXRFSTtBQXVFTGtDLHNCQUFjLHNCQUFVMUQsS0FBVixFQUFpQjtBQUMzQixnQkFBSW9ELE9BQU8sS0FBS0EsSUFBaEI7QUFDQTtBQUNBLGdCQUFJc0MsYUFBYXRDLEtBQUtaLElBQUwsS0FBYyxNQUEvQjtBQUNBLGdCQUFJa0QsY0FBYyxDQUFDbkYsWUFBWVAsS0FBWixDQUFuQixFQUF1QztBQUNuQ0Esd0JBQVFvRCxLQUFLTixPQUFiO0FBQ0gsYUFGRCxNQUdLLElBQUksQ0FBQzRDLFVBQUQsSUFBZSxDQUFDMUYsS0FBcEIsRUFBMkI7QUFDNUIsb0JBQUlnRCxVQUFVSSxLQUFLSixPQUFuQjtBQUNBaEQsd0JBQVFpQixRQUFRK0IsT0FBUixJQUFtQixLQUEzQjtBQUNIO0FBQ0Q7QUFDQSxnQkFBSSxDQUFDMEMsVUFBTCxFQUFpQjtBQUNiLG9CQUFJVixLQUFLaEYsTUFBTTJGLEtBQU4sQ0FBWSxHQUFaLENBQVQ7QUFBQSxvQkFBMkJDLE9BQU9aLEdBQUcsQ0FBSCxDQUFsQztBQUFBLG9CQUF5Q2EsU0FBU2IsR0FBRyxDQUFILENBQWxEO0FBQ0FZLHVCQUFPM0UsUUFBUUwsTUFBTWdGLElBQU4sRUFBWXhDLEtBQUtKLE9BQWpCLEVBQTBCSSxLQUFLSCxPQUEvQixDQUFSLENBQVA7QUFDQTRDLHlCQUFTNUUsUUFBUUwsTUFBTWlGLE1BQU4sRUFBY3pDLEtBQUtGLFNBQW5CLEVBQThCRSxLQUFLRCxTQUFuQyxDQUFSLENBQVQ7QUFDQSx1QkFBT3lDLE9BQU8sR0FBUCxHQUFhQyxNQUFwQjtBQUNIO0FBQ0Q7QUFDQTdGLG9CQUFRZ0IsS0FBS0QsR0FBTCxDQUFTZixLQUFULEVBQWdCb0QsS0FBS04sT0FBckIsQ0FBUjtBQUNBOUMsb0JBQVFnQixLQUFLRixHQUFMLENBQVNkLEtBQVQsRUFBZ0JvRCxLQUFLTCxPQUFyQixDQUFSO0FBQ0EsbUJBQU8vQyxLQUFQO0FBQ0gsU0E3Rkk7QUE4RkxtRixxQkFBYSxxQkFBVTNDLElBQVYsRUFBZ0JhLFVBQWhCLEVBQTRCO0FBQ3JDLGdCQUFJMkIsRUFBSjtBQUNBLGdCQUFJaEYsUUFBUSxJQUFJSyxJQUFKLENBQVNnRCxVQUFULENBQVo7QUFDQSxnQkFBSXlDLFdBQVcsSUFBSXpGLElBQUosQ0FBUyxLQUFLK0MsSUFBTCxDQUFVWixPQUFPLE1BQWpCLENBQVQsQ0FBZjtBQUNBLGdCQUFJVixPQUFPZ0UsU0FBU3hGLFdBQVQsRUFBWDtBQUNBLGdCQUFJeUIsUUFBUSxDQUFaO0FBQ0EsZ0JBQUl2QixPQUFPLENBQVg7QUFDQSxnQkFBSW9GLE9BQU8sQ0FBWDtBQUNBLGdCQUFJQyxTQUFTLENBQWI7QUFDQSxnQkFBSXJELFNBQVMsS0FBYixFQUFvQjtBQUNoQlQsd0JBQVEsRUFBUjtBQUNBdkIsdUJBQU9xQixlQUFlN0IsTUFBTU0sV0FBTixFQUFmLEVBQW9DTixNQUFNK0YsUUFBTixLQUFtQixDQUF2RCxDQUFQO0FBQ0FILHVCQUFPLEVBQVA7QUFDQUMseUJBQVMsRUFBVDtBQUNIO0FBQ0QsZ0JBQUk3RixNQUFNTSxXQUFOLE9BQXdCd0IsSUFBNUIsRUFBa0M7QUFDOUJDLHdCQUFRK0QsU0FBU0MsUUFBVCxLQUFzQixDQUE5QjtBQUNBLG9CQUFJL0YsTUFBTStGLFFBQU4sS0FBbUIsQ0FBbkIsS0FBeUJoRSxLQUE3QixFQUFvQztBQUNoQ3ZCLDJCQUFPc0YsU0FBUzlELE9BQVQsRUFBUDtBQUNBLHdCQUFJaEMsTUFBTWdDLE9BQU4sT0FBb0J4QixJQUF4QixFQUE4QjtBQUMxQm9GLCtCQUFPRSxTQUFTRSxRQUFULEVBQVA7QUFDQSw0QkFBSWhHLE1BQU1nRyxRQUFOLE9BQXFCSixJQUF6QixFQUErQjtBQUMzQkMscUNBQVNDLFNBQVNHLFVBQVQsRUFBVDtBQUNIO0FBQ0o7QUFDSjtBQUNKO0FBQ0QsbUJBQU9qQixLQUFLLEVBQUwsRUFDSEEsR0FBR3hDLE9BQU8sTUFBVixJQUFvQlYsSUFEakIsRUFFSGtELEdBQUd4QyxPQUFPLE9BQVYsSUFBcUJULEtBRmxCLEVBR0hpRCxHQUFHeEMsT0FBTyxNQUFWLElBQW9CaEMsSUFIakIsRUFJSHdFLEdBQUd4QyxPQUFPLE1BQVYsSUFBb0JvRCxJQUpqQixFQUtIWixHQUFHeEMsT0FBTyxRQUFWLElBQXNCcUQsTUFMbkIsRUFNSGIsRUFOSjtBQU9ILFNBaElJO0FBaUlMa0Isa0JBQVUsb0JBQVk7QUFDbEIsaUJBQUtwQyxLQUFMLENBQVcsUUFBWDtBQUNILFNBbklJO0FBb0lMcUMsbUJBQVcscUJBQVk7QUFDbkIsaUJBQUtyQyxLQUFMLENBQVcsU0FBWCxFQUFzQixLQUFLVixJQUFMLENBQVVDLFVBQWhDO0FBQ0gsU0F0SUk7QUF1SUwrQyxrQkFBVSxvQkFBWTtBQUNsQixnQkFBSTNDLFFBQVEsSUFBWjtBQUNBLGdCQUFJTCxPQUFPLEtBQUtBLElBQWhCO0FBQ0EsZ0JBQUlwRCxLQUFKO0FBQ0EsZ0JBQUlpRSxTQUFTLEtBQUtELFNBQUwsRUFBYjtBQUNBLGdCQUFJWixLQUFLWixJQUFMLEtBQWMsTUFBbEIsRUFBMEI7QUFDdEIsb0JBQUk2RCxVQUFVcEMsT0FBT3FDLFVBQVAsRUFBZDtBQUNBdEcsd0JBQVFxRyxRQUFRLENBQVIsSUFBYWpELEtBQUtKLE9BQWxCLEdBQTRCLEdBQTVCLElBQW1DcUQsUUFBUSxDQUFSLElBQWFqRCxLQUFLRixTQUFyRCxDQUFSO0FBQ0gsYUFIRCxNQUlLO0FBQ0Qsb0JBQUkrQixTQUFTaEIsT0FBT3NDLFNBQVAsRUFBYjtBQUNBLG9CQUFJekUsT0FBT0osYUFBYXVELE9BQU8sQ0FBUCxDQUFiLENBQVg7QUFDQSxvQkFBSWxELFFBQVFMLGFBQWF1RCxPQUFPLENBQVAsQ0FBYixDQUFaO0FBQ0Esb0JBQUlsQyxVQUFVbEIsZUFBZUMsSUFBZixFQUFxQkMsS0FBckIsQ0FBZDtBQUNBLG9CQUFJdkIsT0FBT2tCLGFBQWF1RCxPQUFPLENBQVAsQ0FBYixDQUFYO0FBQ0Esb0JBQUk3QixLQUFLWixJQUFMLEtBQWMsWUFBbEIsRUFBZ0M7QUFDNUJoQywyQkFBTyxDQUFQO0FBQ0g7QUFDREEsdUJBQU9BLE9BQU91QyxPQUFQLEdBQWlCQSxPQUFqQixHQUEyQnZDLElBQWxDO0FBQ0Esb0JBQUlvRixPQUFPLENBQVg7QUFDQSxvQkFBSUMsU0FBUyxDQUFiO0FBQ0Esb0JBQUl6QyxLQUFLWixJQUFMLEtBQWMsVUFBbEIsRUFBOEI7QUFDMUJvRCwyQkFBT2xFLGFBQWF1RCxPQUFPLENBQVAsQ0FBYixDQUFQO0FBQ0FZLDZCQUFTbkUsYUFBYXVELE9BQU8sQ0FBUCxDQUFiLENBQVQ7QUFDSDtBQUNEakYsd0JBQVEsSUFBSUssSUFBSixDQUFTeUIsSUFBVCxFQUFlQyxRQUFRLENBQXZCLEVBQTBCdkIsSUFBMUIsRUFBZ0NvRixJQUFoQyxFQUFzQ0MsTUFBdEMsQ0FBUjtBQUNIO0FBQ0Q3RixvQkFBUSxLQUFLMEQsWUFBTCxDQUFrQjFELEtBQWxCLENBQVI7QUFDQSxpQkFBSzRELGlCQUFMLENBQXVCNUQsS0FBdkIsRUFBOEI2RCxJQUE5QixDQUFtQyxZQUFZO0FBQzNDSixzQkFBTUssS0FBTixDQUFZLE9BQVosRUFBcUI5RCxLQUFyQjtBQUNBeUQsc0JBQU1LLEtBQU4sQ0FBWSxRQUFaLEVBQXNCRyxNQUF0QjtBQUNILGFBSEQ7QUFJSCxTQXZLSTtBQXdLTEwsMkJBQW1CLDJCQUFVNUQsS0FBVixFQUFpQjtBQUNoQyxnQkFBSXlELFFBQVEsSUFBWjtBQUNBLGdCQUFJd0IsU0FBUyxFQUFiO0FBQ0EsZ0JBQUk3QixPQUFPLEtBQUtBLElBQWhCO0FBQ0EsZ0JBQUlhLFNBQVMsS0FBS0QsU0FBTCxFQUFiO0FBQ0EsZ0JBQUlaLEtBQUtaLElBQUwsS0FBYyxNQUFsQixFQUEwQjtBQUN0QixvQkFBSWdFLE9BQU94RyxNQUFNMkYsS0FBTixDQUFZLEdBQVosQ0FBWDtBQUNBVix5QkFBUyxDQUFDdUIsS0FBSyxDQUFMLENBQUQsRUFBVUEsS0FBSyxDQUFMLENBQVYsQ0FBVDtBQUNILGFBSEQsTUFJSztBQUNELG9CQUFJaEcsT0FBTyxJQUFJSCxJQUFKLENBQVNMLEtBQVQsQ0FBWDtBQUNBaUYseUJBQVMsQ0FBQyxLQUFLekUsS0FBS0YsV0FBTCxFQUFOLEVBQTBCVyxRQUFRVCxLQUFLdUYsUUFBTCxLQUFrQixDQUExQixDQUExQixDQUFUO0FBQ0Esb0JBQUkzQyxLQUFLWixJQUFMLEtBQWMsTUFBbEIsRUFBMEI7QUFDdEJ5QywyQkFBT3dCLElBQVAsQ0FBWXhGLFFBQVFULEtBQUt3QixPQUFMLEVBQVIsQ0FBWjtBQUNIO0FBQ0Qsb0JBQUlvQixLQUFLWixJQUFMLEtBQWMsVUFBbEIsRUFBOEI7QUFDMUJ5QywyQkFBT3dCLElBQVAsQ0FBWXhGLFFBQVFULEtBQUt3QixPQUFMLEVBQVIsQ0FBWixFQUFxQ2YsUUFBUVQsS0FBS3dGLFFBQUwsRUFBUixDQUFyQyxFQUErRC9FLFFBQVFULEtBQUt5RixVQUFMLEVBQVIsQ0FBL0Q7QUFDSDtBQUNKO0FBQ0QsbUJBQU8sS0FBS2YsR0FBTCxDQUFTLEVBQUU3QixZQUFZckQsS0FBZCxFQUFULEVBQ0Y2RCxJQURFLENBQ0csWUFBWTtBQUFFLHVCQUFPSixNQUFNbUIsYUFBTixFQUFQO0FBQStCLGFBRGhELEVBRUZmLElBRkUsQ0FFRyxZQUFZO0FBQUUsdUJBQU9JLE9BQU95QyxTQUFQLENBQWlCekIsTUFBakIsQ0FBUDtBQUFrQyxhQUZuRCxDQUFQO0FBR0g7QUE5TEksS0E1RWE7QUE0UXRCMEIsYUFBUyxtQkFBWTtBQUNqQixZQUFJbEQsUUFBUSxJQUFaO0FBQ0EsWUFBSUosYUFBYSxLQUFLSyxZQUFMLENBQWtCLEtBQUtOLElBQUwsQ0FBVXBELEtBQTVCLENBQWpCO0FBQ0EsYUFBSzRELGlCQUFMLENBQXVCUCxVQUF2QixFQUFtQ1EsSUFBbkMsQ0FBd0MsWUFBWTtBQUNoREosa0JBQU1LLEtBQU4sQ0FBWSxPQUFaLEVBQXFCVCxVQUFyQjtBQUNILFNBRkQ7QUFHSDtBQWxScUIsQ0FBMUIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbnZhciBjb21wb25lbnRfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29tcG9uZW50XCIpO1xudmFyIHV0aWxzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzXCIpO1xudmFyIGN1cnJlbnRZZWFyID0gbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpO1xuZnVuY3Rpb24gaXNWYWxpZERhdGUoZGF0ZSkge1xuICAgIHJldHVybiB1dGlsc18xLmlzRGVmKGRhdGUpICYmICFpc05hTihuZXcgRGF0ZShkYXRlKS5nZXRUaW1lKCkpO1xufVxuZnVuY3Rpb24gcmFuZ2UobnVtLCBtaW4sIG1heCkge1xuICAgIHJldHVybiBNYXRoLm1pbihNYXRoLm1heChudW0sIG1pbiksIG1heCk7XG59XG5mdW5jdGlvbiBwYWRaZXJvKHZhbCkge1xuICAgIHJldHVybiAoXCIwMFwiICsgdmFsKS5zbGljZSgtMik7XG59XG5mdW5jdGlvbiB0aW1lcyhuLCBpdGVyYXRlZSkge1xuICAgIHZhciBpbmRleCA9IC0xO1xuICAgIHZhciByZXN1bHQgPSBBcnJheShuKTtcbiAgICB3aGlsZSAoKytpbmRleCA8IG4pIHtcbiAgICAgICAgcmVzdWx0W2luZGV4XSA9IGl0ZXJhdGVlKGluZGV4KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbmZ1bmN0aW9uIGdldFRydWVWYWx1ZShmb3JtYXR0ZWRWYWx1ZSkge1xuICAgIGlmICghZm9ybWF0dGVkVmFsdWUpXG4gICAgICAgIHJldHVybjtcbiAgICB3aGlsZSAoaXNOYU4ocGFyc2VJbnQoZm9ybWF0dGVkVmFsdWUsIDEwKSkpIHtcbiAgICAgICAgZm9ybWF0dGVkVmFsdWUgPSBmb3JtYXR0ZWRWYWx1ZS5zbGljZSgxKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcnNlSW50KGZvcm1hdHRlZFZhbHVlLCAxMCk7XG59XG5mdW5jdGlvbiBnZXRNb250aEVuZERheSh5ZWFyLCBtb250aCkge1xuICAgIHJldHVybiAzMiAtIG5ldyBEYXRlKHllYXIsIG1vbnRoIC0gMSwgMzIpLmdldERhdGUoKTtcbn1cbmNvbXBvbmVudF8xLlZhbnRDb21wb25lbnQoe1xuICAgIHByb3BzOiB7XG4gICAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgICB0aXRsZTogU3RyaW5nLFxuICAgICAgICBsb2FkaW5nOiBCb29sZWFuLFxuICAgICAgICBpdGVtSGVpZ2h0OiB7XG4gICAgICAgICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICAgICAgICB2YWx1ZTogNDRcbiAgICAgICAgfSxcbiAgICAgICAgdmlzaWJsZUl0ZW1Db3VudDoge1xuICAgICAgICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgICAgICAgdmFsdWU6IDVcbiAgICAgICAgfSxcbiAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6IHtcbiAgICAgICAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgICAgICAgIHZhbHVlOiAn56Gu6K6kJ1xuICAgICAgICB9LFxuICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiB7XG4gICAgICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgICAgICB2YWx1ZTogJ+WPlua2iCdcbiAgICAgICAgfSxcbiAgICAgICAgdHlwZToge1xuICAgICAgICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgICAgICAgdmFsdWU6ICdkYXRldGltZSdcbiAgICAgICAgfSxcbiAgICAgICAgc2hvd1Rvb2xiYXI6IHtcbiAgICAgICAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICAgICAgICB2YWx1ZTogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICBtaW5EYXRlOiB7XG4gICAgICAgICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICAgICAgICB2YWx1ZTogbmV3IERhdGUoY3VycmVudFllYXIgLSAxMCwgMCwgMSkuZ2V0VGltZSgpXG4gICAgICAgIH0sXG4gICAgICAgIG1heERhdGU6IHtcbiAgICAgICAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgICAgICAgIHZhbHVlOiBuZXcgRGF0ZShjdXJyZW50WWVhciArIDEwLCAxMSwgMzEpLmdldFRpbWUoKVxuICAgICAgICB9LFxuICAgICAgICBtaW5Ib3VyOiB7XG4gICAgICAgICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICAgICAgICB2YWx1ZTogMFxuICAgICAgICB9LFxuICAgICAgICBtYXhIb3VyOiB7XG4gICAgICAgICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICAgICAgICB2YWx1ZTogMjNcbiAgICAgICAgfSxcbiAgICAgICAgbWluTWludXRlOiB7XG4gICAgICAgICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICAgICAgICB2YWx1ZTogMFxuICAgICAgICB9LFxuICAgICAgICBtYXhNaW51dGU6IHtcbiAgICAgICAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgICAgICAgIHZhbHVlOiA1OVxuICAgICAgICB9XG4gICAgfSxcbiAgICBkYXRhOiB7XG4gICAgICAgIGlubmVyVmFsdWU6IERhdGUubm93KCksXG4gICAgICAgIGNvbHVtbnM6IFtdXG4gICAgfSxcbiAgICB3YXRjaDoge1xuICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKHZhbCkge1xuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgICAgICAgICAgdmFsID0gdGhpcy5jb3JyZWN0VmFsdWUodmFsKTtcbiAgICAgICAgICAgIHZhciBpc0VxdWFsID0gdmFsID09PSBkYXRhLmlubmVyVmFsdWU7XG4gICAgICAgICAgICBpZiAoIWlzRXF1YWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNvbHVtblZhbHVlKHZhbCkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLiRlbWl0KCdpbnB1dCcsIHZhbCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHR5cGU6ICd1cGRhdGVDb2x1bW5zJyxcbiAgICAgICAgbWluSG91cjogJ3VwZGF0ZUNvbHVtbnMnLFxuICAgICAgICBtYXhIb3VyOiAndXBkYXRlQ29sdW1ucycsXG4gICAgICAgIG1pbk1pbnV0ZTogJ3VwZGF0ZUNvbHVtbnMnLFxuICAgICAgICBtYXhNaW51dGU6ICd1cGRhdGVDb2x1bW5zJ1xuICAgIH0sXG4gICAgbWV0aG9kczoge1xuICAgICAgICBnZXRQaWNrZXI6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnBpY2tlciA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBpY2tlcl8xID0gdGhpcy5waWNrZXIgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnZhbi1kYXRldGltZS1waWNrZXInKTtcbiAgICAgICAgICAgICAgICB2YXIgc2V0Q29sdW1uVmFsdWVzXzEgPSBwaWNrZXJfMS5zZXRDb2x1bW5WYWx1ZXM7XG4gICAgICAgICAgICAgICAgcGlja2VyXzEuc2V0Q29sdW1uVmFsdWVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXRDb2x1bW5WYWx1ZXNfMS5hcHBseShwaWNrZXJfMSwgYXJncy5jb25jYXQoW2ZhbHNlXSkpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5waWNrZXI7XG4gICAgICAgIH0sXG4gICAgICAgIHVwZGF0ZUNvbHVtbnM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciByZXN1bHRzID0gdGhpcy5nZXRSYW5nZXMoKS5tYXAoZnVuY3Rpb24gKF9hLCBpbmRleCkge1xuICAgICAgICAgICAgICAgIHZhciB0eXBlID0gX2EudHlwZSwgcmFuZ2UgPSBfYS5yYW5nZTtcbiAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gdGltZXMocmFuZ2VbMV0gLSByYW5nZVswXSArIDEsIGZ1bmN0aW9uIChpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSByYW5nZVswXSArIGluZGV4O1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHR5cGUgPT09ICd5ZWFyJyA/IFwiXCIgKyB2YWx1ZSA6IHBhZFplcm8odmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgdmFsdWVzOiB2YWx1ZXMgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0KHsgY29sdW1uczogcmVzdWx0cyB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0UmFuZ2VzOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09ICd0aW1lJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdob3VyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlOiBbZGF0YS5taW5Ib3VyLCBkYXRhLm1heEhvdXJdXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdtaW51dGUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IFtkYXRhLm1pbk1pbnV0ZSwgZGF0YS5tYXhNaW51dGVdXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIF9hID0gdGhpcy5nZXRCb3VuZGFyeSgnbWF4JywgZGF0YS5pbm5lclZhbHVlKSwgbWF4WWVhciA9IF9hLm1heFllYXIsIG1heERhdGUgPSBfYS5tYXhEYXRlLCBtYXhNb250aCA9IF9hLm1heE1vbnRoLCBtYXhIb3VyID0gX2EubWF4SG91ciwgbWF4TWludXRlID0gX2EubWF4TWludXRlO1xuICAgICAgICAgICAgdmFyIF9iID0gdGhpcy5nZXRCb3VuZGFyeSgnbWluJywgZGF0YS5pbm5lclZhbHVlKSwgbWluWWVhciA9IF9iLm1pblllYXIsIG1pbkRhdGUgPSBfYi5taW5EYXRlLCBtaW5Nb250aCA9IF9iLm1pbk1vbnRoLCBtaW5Ib3VyID0gX2IubWluSG91ciwgbWluTWludXRlID0gX2IubWluTWludXRlO1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICd5ZWFyJyxcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IFttaW5ZZWFyLCBtYXhZZWFyXVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnbW9udGgnLFxuICAgICAgICAgICAgICAgICAgICByYW5nZTogW21pbk1vbnRoLCBtYXhNb250aF1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2RheScsXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlOiBbbWluRGF0ZSwgbWF4RGF0ZV1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2hvdXInLFxuICAgICAgICAgICAgICAgICAgICByYW5nZTogW21pbkhvdXIsIG1heEhvdXJdXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdtaW51dGUnLFxuICAgICAgICAgICAgICAgICAgICByYW5nZTogW21pbk1pbnV0ZSwgbWF4TWludXRlXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICBpZiAoZGF0YS50eXBlID09PSAnZGF0ZScpXG4gICAgICAgICAgICAgICAgcmVzdWx0LnNwbGljZSgzLCAyKTtcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09ICd5ZWFyLW1vbnRoJylcbiAgICAgICAgICAgICAgICByZXN1bHQuc3BsaWNlKDIsIDMpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSxcbiAgICAgICAgY29ycmVjdFZhbHVlOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgICAgICAgICAgLy8gdmFsaWRhdGUgdmFsdWVcbiAgICAgICAgICAgIHZhciBpc0RhdGVUeXBlID0gZGF0YS50eXBlICE9PSAndGltZSc7XG4gICAgICAgICAgICBpZiAoaXNEYXRlVHlwZSAmJiAhaXNWYWxpZERhdGUodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBkYXRhLm1pbkRhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICghaXNEYXRlVHlwZSAmJiAhdmFsdWUpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWluSG91ciA9IGRhdGEubWluSG91cjtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHBhZFplcm8obWluSG91cikgKyBcIjowMFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gdGltZSB0eXBlXG4gICAgICAgICAgICBpZiAoIWlzRGF0ZVR5cGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgX2EgPSB2YWx1ZS5zcGxpdCgnOicpLCBob3VyID0gX2FbMF0sIG1pbnV0ZSA9IF9hWzFdO1xuICAgICAgICAgICAgICAgIGhvdXIgPSBwYWRaZXJvKHJhbmdlKGhvdXIsIGRhdGEubWluSG91ciwgZGF0YS5tYXhIb3VyKSk7XG4gICAgICAgICAgICAgICAgbWludXRlID0gcGFkWmVybyhyYW5nZShtaW51dGUsIGRhdGEubWluTWludXRlLCBkYXRhLm1heE1pbnV0ZSkpO1xuICAgICAgICAgICAgICAgIHJldHVybiBob3VyICsgXCI6XCIgKyBtaW51dGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBkYXRlIHR5cGVcbiAgICAgICAgICAgIHZhbHVlID0gTWF0aC5tYXgodmFsdWUsIGRhdGEubWluRGF0ZSk7XG4gICAgICAgICAgICB2YWx1ZSA9IE1hdGgubWluKHZhbHVlLCBkYXRhLm1heERhdGUpO1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9LFxuICAgICAgICBnZXRCb3VuZGFyeTogZnVuY3Rpb24gKHR5cGUsIGlubmVyVmFsdWUpIHtcbiAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5ldyBEYXRlKGlubmVyVmFsdWUpO1xuICAgICAgICAgICAgdmFyIGJvdW5kYXJ5ID0gbmV3IERhdGUodGhpcy5kYXRhW3R5cGUgKyBcIkRhdGVcIl0pO1xuICAgICAgICAgICAgdmFyIHllYXIgPSBib3VuZGFyeS5nZXRGdWxsWWVhcigpO1xuICAgICAgICAgICAgdmFyIG1vbnRoID0gMTtcbiAgICAgICAgICAgIHZhciBkYXRlID0gMTtcbiAgICAgICAgICAgIHZhciBob3VyID0gMDtcbiAgICAgICAgICAgIHZhciBtaW51dGUgPSAwO1xuICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdtYXgnKSB7XG4gICAgICAgICAgICAgICAgbW9udGggPSAxMjtcbiAgICAgICAgICAgICAgICBkYXRlID0gZ2V0TW9udGhFbmREYXkodmFsdWUuZ2V0RnVsbFllYXIoKSwgdmFsdWUuZ2V0TW9udGgoKSArIDEpO1xuICAgICAgICAgICAgICAgIGhvdXIgPSAyMztcbiAgICAgICAgICAgICAgICBtaW51dGUgPSA1OTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh2YWx1ZS5nZXRGdWxsWWVhcigpID09PSB5ZWFyKSB7XG4gICAgICAgICAgICAgICAgbW9udGggPSBib3VuZGFyeS5nZXRNb250aCgpICsgMTtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUuZ2V0TW9udGgoKSArIDEgPT09IG1vbnRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGUgPSBib3VuZGFyeS5nZXREYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5nZXREYXRlKCkgPT09IGRhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvdXIgPSBib3VuZGFyeS5nZXRIb3VycygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLmdldEhvdXJzKCkgPT09IGhvdXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW51dGUgPSBib3VuZGFyeS5nZXRNaW51dGVzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gX2EgPSB7fSxcbiAgICAgICAgICAgICAgICBfYVt0eXBlICsgXCJZZWFyXCJdID0geWVhcixcbiAgICAgICAgICAgICAgICBfYVt0eXBlICsgXCJNb250aFwiXSA9IG1vbnRoLFxuICAgICAgICAgICAgICAgIF9hW3R5cGUgKyBcIkRhdGVcIl0gPSBkYXRlLFxuICAgICAgICAgICAgICAgIF9hW3R5cGUgKyBcIkhvdXJcIl0gPSBob3VyLFxuICAgICAgICAgICAgICAgIF9hW3R5cGUgKyBcIk1pbnV0ZVwiXSA9IG1pbnV0ZSxcbiAgICAgICAgICAgICAgICBfYTtcbiAgICAgICAgfSxcbiAgICAgICAgb25DYW5jZWw6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuJGVtaXQoJ2NhbmNlbCcpO1xuICAgICAgICB9LFxuICAgICAgICBvbkNvbmZpcm06IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuJGVtaXQoJ2NvbmZpcm0nLCB0aGlzLmRhdGEuaW5uZXJWYWx1ZSk7XG4gICAgICAgIH0sXG4gICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgICAgICAgICB2YXIgdmFsdWU7XG4gICAgICAgICAgICB2YXIgcGlja2VyID0gdGhpcy5nZXRQaWNrZXIoKTtcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09ICd0aW1lJykge1xuICAgICAgICAgICAgICAgIHZhciBpbmRleGVzID0gcGlja2VyLmdldEluZGV4ZXMoKTtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGluZGV4ZXNbMF0gKyBkYXRhLm1pbkhvdXIgKyBcIjpcIiArIChpbmRleGVzWzFdICsgZGF0YS5taW5NaW51dGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IHBpY2tlci5nZXRWYWx1ZXMoKTtcbiAgICAgICAgICAgICAgICB2YXIgeWVhciA9IGdldFRydWVWYWx1ZSh2YWx1ZXNbMF0pO1xuICAgICAgICAgICAgICAgIHZhciBtb250aCA9IGdldFRydWVWYWx1ZSh2YWx1ZXNbMV0pO1xuICAgICAgICAgICAgICAgIHZhciBtYXhEYXRlID0gZ2V0TW9udGhFbmREYXkoeWVhciwgbW9udGgpO1xuICAgICAgICAgICAgICAgIHZhciBkYXRlID0gZ2V0VHJ1ZVZhbHVlKHZhbHVlc1syXSk7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ3llYXItbW9udGgnKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGUgPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkYXRlID0gZGF0ZSA+IG1heERhdGUgPyBtYXhEYXRlIDogZGF0ZTtcbiAgICAgICAgICAgICAgICB2YXIgaG91ciA9IDA7XG4gICAgICAgICAgICAgICAgdmFyIG1pbnV0ZSA9IDA7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ2RhdGV0aW1lJykge1xuICAgICAgICAgICAgICAgICAgICBob3VyID0gZ2V0VHJ1ZVZhbHVlKHZhbHVlc1szXSk7XG4gICAgICAgICAgICAgICAgICAgIG1pbnV0ZSA9IGdldFRydWVWYWx1ZSh2YWx1ZXNbNF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ldyBEYXRlKHllYXIsIG1vbnRoIC0gMSwgZGF0ZSwgaG91ciwgbWludXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5jb3JyZWN0VmFsdWUodmFsdWUpO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5WYWx1ZSh2YWx1ZSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgX3RoaXMuJGVtaXQoJ2lucHV0JywgdmFsdWUpO1xuICAgICAgICAgICAgICAgIF90aGlzLiRlbWl0KCdjaGFuZ2UnLCBwaWNrZXIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIHVwZGF0ZUNvbHVtblZhbHVlOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICB2YXIgdmFsdWVzID0gW107XG4gICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgICAgICAgIHZhciBwaWNrZXIgPSB0aGlzLmdldFBpY2tlcigpO1xuICAgICAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ3RpbWUnKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhaXIgPSB2YWx1ZS5zcGxpdCgnOicpO1xuICAgICAgICAgICAgICAgIHZhbHVlcyA9IFtwYWlyWzBdLCBwYWlyWzFdXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUodmFsdWUpO1xuICAgICAgICAgICAgICAgIHZhbHVlcyA9IFtcIlwiICsgZGF0ZS5nZXRGdWxsWWVhcigpLCBwYWRaZXJvKGRhdGUuZ2V0TW9udGgoKSArIDEpXTtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS50eXBlID09PSAnZGF0ZScpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2gocGFkWmVybyhkYXRlLmdldERhdGUoKSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZGF0YS50eXBlID09PSAnZGF0ZXRpbWUnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHBhZFplcm8oZGF0ZS5nZXREYXRlKCkpLCBwYWRaZXJvKGRhdGUuZ2V0SG91cnMoKSksIHBhZFplcm8oZGF0ZS5nZXRNaW51dGVzKCkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQoeyBpbm5lclZhbHVlOiB2YWx1ZSB9KVxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLnVwZGF0ZUNvbHVtbnMoKTsgfSlcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBwaWNrZXIuc2V0VmFsdWVzKHZhbHVlcyk7IH0pO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBjcmVhdGVkOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHZhciBpbm5lclZhbHVlID0gdGhpcy5jb3JyZWN0VmFsdWUodGhpcy5kYXRhLnZhbHVlKTtcbiAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5WYWx1ZShpbm5lclZhbHVlKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIF90aGlzLiRlbWl0KCdpbnB1dCcsIGlubmVyVmFsdWUpO1xuICAgICAgICB9KTtcbiAgICB9XG59KTtcbiJdfQ==